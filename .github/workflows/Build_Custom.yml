#=================================================
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT 
#=================================================

name: Build_Custom

on: 
  repository_dispatch:
  workflow_dispatch:
    inputs:
      config_filename:
        description: 'Configuration file name in repository (e.g., x86_64.config)'
        required: true
        default: 'cc.config'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
      options: --privileged

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Clean workspace
      run: |
        rm -rf /var/cache/apk/*
        rm -rf /tmp/*
        echo "Workspace cleaned"

    - name: Install essential build tools 
      run: |
        apk update
        apk add --no-cache \
          bash \
          git \
          curl \
          wget \
          xz \
          tar \
          gzip \
          bzip2 \
          zip \
          unzip \
          coreutils \
          findutils \
          grep \
          sed \
          gawk \
          make \
          gcc \
          g++ \
          binutils \
          cmake \
          ninja \
          patch \
          pkgconf \
          perl \
          python3 \
          py3-pip \
          rsync \
          ccache \
          gettext-dev \
          ncurses-dev \
          openssl-dev \
          zlib-dev \
          libtool \
          autoconf \
          automake \
          bison \
          flex \
          gawk \
          help2man \
          intltool \
          patchutils \
          scons \
          texinfo \
          diffutils \
          argp-standalone-dev \
          musl-fts-dev \
          musl-obstack-dev \

    - name: Clone source code
      env: 
        REPO_URL: https://github.com/openwrt/openwrt
        REPO_BRANCH: openwrt-24.10
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        
    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configuration Customization
      env:
        CONFIG_FILE: '${{ github.event.inputs.config_filename }}'
      run: |
        echo "Using configuration file: $CONFIG_FILE"
        if [ -e "$CONFIG_FILE" ]; then
          echo "Configuration file found, applying..."
          cp "$CONFIG_FILE" openwrt/.config
        else
          echo "Warning: Configuration file $CONFIG_FILE not found!"
          echo "Using default configuration..."
        fi
       
        
        cd openwrt && make defconfig
        
    - name: Download packages
      working-directory: ./openwrt
      run: |
        make download -j$(( $(nproc) + 1 ))
        # Remove incomplete downloads
        find dl -size -1024c -delete 2>/dev/null || true

    - name: Build firmware
      working-directory: ./openwrt
      run: |
        echo "Building with $(nproc) threads"
        make -j$(( $(nproc) + 1 )) V=s

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_${{ github.event.inputs.config_filename }}_${{ github.run_id }}
        path: openwrt/bin
